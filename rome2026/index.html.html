<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å—ç¾©ä¹‹æ—…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0e6d2; user-select: none; -webkit-user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-rome-sketch { background-image: url('https://img.freepik.com/free-vector/hand-drawn-rome-landmark-pattern_23-2149463959.jpg'); background-size: 400px; background-blend-mode: overlay; opacity: 0.15; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .sortable-ghost { opacity: 0.2; background-color: #ef4444; border: 2px dashed #8E3228; }
        .sortable-drag { cursor: grabbing !important; opacity: 1; background: white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); transform: scale(1.02); z-index: 9999; }
        .item-card { cursor: grab; transition: transform 0.1s; position: relative; }
        .item-card:active { cursor: grabbing; }
        #map-container { z-index: 1; height: 100%; width: 100%; border-radius: 0.75rem; }
        .custom-pin-icon { background-color: #8E3228; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px rgba(142, 50, 40, 0.3), 0 3px 6px rgba(0,0,0,0.4); }
        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; }
        .leaflet-popup-content { margin: 0; font-family: 'Noto Sans TC'; min-width: 200px; }
        .popup-header { background: #8E3228; color: white; padding: 8px 12px; font-size: 14px; font-weight: bold; }
        .popup-body { padding: 12px; font-size: 13px; color: #4b5563; }
        .popup-btn { display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; background: #2563eb; color: white; padding: 8px; margin-top: 8px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 12px; }
        .date-active { background-color: #8E3228 !important; border-color: #8E3228 !important; color: white !important; transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .date-inactive { background-color: white; color: #6b7280; border-color: #e5e7eb; }
        .fab-btn { background-color: #8E3228; box-shadow: 0 10px 20px -5px rgba(127, 29, 29, 0.5); border: 2px solid white; }
        .fab-btn:active { background-color: #450a0a; transform: scale(0.95); }
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; max-height: 200px; overflow-y: auto; }
        .suggestion-item { padding: 0.75rem 1rem; font-size: 0.875rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
        .suggestion-item:hover { background-color: #fff1f2; color: #8E3228; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #ef4444; transition: all 0.3s; }
        .status-dot.online { background: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .btn-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; cursor: pointer; }
        .btn-edit:hover { background-color: #e5e7eb; color: #374151; }
        .btn-delete:hover { background-color: #fee2e2; color: #dc2626; }
        .card-actions { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 12px; padding-left: 12px; border-left: 1px solid #f3f4f6; margin-left: auto; min-width: 50px; background-color: #f9fafb; }
        #debug-console { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: #ef4444; z-index: 99999; padding: 20px; font-family: monospace; overflow: auto; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col items-center justify-center bg-[#e5e5e5]">
    <div id="debug-console"><h2 class="text-2xl font-bold text-white mb-4">âš ï¸ éŒ¯èª¤å›å ±</h2><pre id="error-msg" class="bg-gray-800 p-4 rounded text-sm whitespace-pre-wrap"></pre><button onclick="location.reload()" class="mt-4 bg-white text-black px-4 py-2 rounded font-bold">é‡æ–°è¼‰å…¥</button></div>
    <div id="app" class="w-full max-w-md h-full sm:h-[95vh] sm:rounded-3xl sm:border-4 sm:border-white sm:shadow-2xl flex flex-col relative bg-[#f5f0e6] overflow-hidden" v-cloak>
        <div class="bg-rome-sketch"></div>
        <header class="bg-gradient-to-r from-[#8E3228] to-[#5e211a] text-white p-5 pt-8 shadow-lg z-20 flex justify-between items-center rounded-b-3xl shrink-0">
            <div>
                <div class="text-[10px] text-rome-gold tracking-[0.3em] uppercase mb-1 font-bold">V40 æœ€çµ‚é©—è­‰ç‰ˆ</div>
                <h1 class="text-2xl font-bold tracking-wide flex items-center gap-2"><i class="fa-solid fa-crown text-rome-gold text-lg"></i> å—ç¾©ä¹‹æ—…</h1>
                <div class="flex items-center gap-2 mt-1 opacity-80 text-[10px]"><div class="status-dot" :class="{ 'online': isDataLoaded }"></div>{{ isDataLoaded ? 'å·²é€£ç·šåŒæ­¥' : 'é€£ç·šä¸­...' }}</div>
            </div>
            <div class="w-12 h-12 rounded-full border-2 border-rome-gold bg-rome-cream shadow-md flex items-center justify-center text-2xl">ğŸ¦</div>
        </header>
        <div v-if="['itinerary', 'expenses'].includes(currentTab)" class="bg-white/80 backdrop-blur-md py-3 shadow-sm z-10 border-b border-rome-gold/20 shrink-0"><div class="flex overflow-x-auto no-scrollbar px-4 space-x-3 snap-x" id="date-scroll-container"><button v-for="(date, index) in dates" :key="date.full" :id="'date-btn-' + index" @click="selectDate(index)" class="flex-shrink-0 snap-center flex flex-col items-center justify-center w-14 h-16 rounded-2xl border transition-all duration-300 relative overflow-hidden" :class="selectedDate === date.full ? 'date-active' : 'date-inactive'"><span class="text-[9px] uppercase font-bold tracking-wider opacity-80">{{ date.month }}</span><span class="text-xl font-bold font-mono">{{ date.day }}</span><div v-if="hasEvent(date.full)" class="absolute bottom-1 w-1 h-1 rounded-full" :class="selectedDate === date.full ? 'bg-white' : 'bg-red-800'"></div></button></div></div>
        <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-28 relative scroll-smooth bg-transparent">
            <div v-show="currentTab === 'itinerary'" class="animate-[fadeIn_0.3s_ease-out]"><div class="text-center mb-2"><span class="text-[10px] text-gray-500 bg-white/50 px-3 py-1 rounded-full shadow-sm"><i class="fa-solid fa-arrows-up-down mr-1"></i> æ‹–æ›³å¯æ’åº</span></div><div ref="itineraryListRef" class="space-y-4 pb-20 min-h-[200px]"><div v-for="(item, index) in currentDayItinerary" :key="item.id" :data-id="item.id" class="item-card group relative bg-white/95 backdrop-blur rounded-xl shadow-sm border-l-4 border-rome-gold overflow-hidden flex items-stretch"><div class="p-4 pl-3 flex-1"><div class="flex justify-between items-start mb-2 pr-2"><div class="flex items-center gap-2"><span class="bg-gray-100 text-gray-700 px-2 py-0.5 rounded text-sm font-bold font-mono">{{ item.time }}</span></div></div><h3 class="text-lg font-bold text-gray-800 leading-tight pr-4">{{ item.location }}</h3><p class="text-sm text-gray-500 mt-1 line-clamp-2 pr-4">{{ item.note }}</p><a :href="`http://googleusercontent.com/maps.google.com/search/${encodeURIComponent(item.location + ' Italy')}`" target="_blank" class="mt-2 inline-flex items-center text-xs font-bold text-[#8E3228] hover:underline"><i class="fa-solid fa-location-arrow mr-1"></i> å°èˆª</a></div><div class="card-actions"><button @click.stop.prevent="editItem(item)" class="btn-icon bg-gray-100 text-gray-500 hover:text-gray-900"><i class="fa-solid fa-pen text-sm"></i></button><button @click.stop.prevent="deleteItem(item.id, 'itinerary')" class="btn-icon bg-red-50 text-red-500 hover:bg-red-500 hover:text-white"><i class="fa-solid fa-trash text-sm"></i></button></div></div></div><div v-if="currentDayItinerary.length === 0" class="text-center py-10 text-gray-400 text-sm">{{ isDataLoaded ? 'æœ¬æ—¥å°šç„¡è¡Œç¨‹ï¼Œé»æ“Š + æ–°å¢' : 'è¼‰å…¥ä¸­...' }}</div></div>
            <div v-show="currentTab === 'expenses'" class="animate-[fadeIn_0.3s_ease-out]"><div class="bg-gradient-to-br from-gray-800 to-gray-900 text-white rounded-2xl p-4 shadow-lg mb-4"><div class="flex divide-x divide-gray-600"><div class="flex-1 pr-4"><p class="text-[10px] text-gray-400 uppercase">æ­å…ƒ (EUR)</p><div class="text-2xl font-bold font-mono text-rome-gold">â‚¬{{ dayTotalEUR }}</div></div><div class="flex-1 pl-4"><p class="text-[10px] text-gray-400 uppercase">å°å¹£ (TWD)</p><div class="text-2xl font-bold font-mono text-blue-300">NT${{ dayTotalTWD }}</div></div></div></div><div ref="expenseListRef" class="space-y-3 pb-20 min-h-[100px]"><div v-for="exp in currentDayExpenses" :key="exp.id" :data-id="exp.id" class="item-card group relative bg-white/90 p-4 rounded-xl shadow-sm flex items-center border-l-4" :class="exp.currency === 'EUR' ? 'border-rome-gold' : 'border-blue-400'" @click="editExpense(exp)"><div class="flex items-center gap-3 flex-1"><div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-lg shrink-0" :class="exp.currency === 'EUR' ? 'text-rome-gold' : 'text-blue-500'"><i :class="getCategoryIcon(exp.category)"></i></div><div><div class="font-bold text-gray-800 text-sm">{{ exp.item }}</div><div class="text-[10px] text-gray-400">{{ exp.category }}</div></div></div><div class="flex items-center gap-3 pr-2"><span class="font-bold font-mono text-sm" :class="exp.currency === 'EUR' ? 'text-gray-800' : 'text-blue-600'">{{ exp.currency === 'EUR' ? 'â‚¬' : 'NT$' }}{{ exp.amount }}</span><button @click.stop.prevent="deleteItem(exp.id, 'expenses')" class="btn-icon bg-red-50 text-red-500 hover:bg-red-500 hover:text-white"><i class="fa-solid fa-trash text-xs"></i></button></div></div></div></div>
            <div v-show="currentTab === 'map'" class="h-full flex flex-col gap-3 animate-[fadeIn_0.3s_ease-out]"><div class="bg-white/95 backdrop-blur rounded-xl p-3 shadow-sm border-l-4 border-rome-gold flex justify-between items-center z-10"><div><h2 class="font-bold text-gray-800 text-sm"><i class="fa-solid fa-map-pin text-rome-red mr-2"></i>{{ currentFullDateDisplay }} è¡Œç¨‹è·¯å¾‘</h2><p class="text-[10px] text-gray-500">å·²é‡˜é¸ {{ currentDayItinerary.length }} å€‹åœ°é»</p></div><button @click="locateMe" class="bg-white text-blue-500 border border-blue-500 text-xs px-3 py-1.5 rounded-full shadow hover:bg-blue-50 transition flex items-center gap-1"><i class="fa-solid fa-location-crosshairs"></i> å®šä½</button></div><div id="map-container" class="flex-1 shadow-inner relative overflow-hidden bg-gray-200 border border-gray-300"></div></div>
            <div v-show="currentTab === 'checklist'" class="bg-white/90 p-5 rounded-xl shadow-sm min-h-[300px]"><h2 class="text-xl font-bold text-[#8E3228] mb-4 border-b pb-2 border-gray-100">è¡Œå‰æº–å‚™æ¸…å–®</h2><div class="space-y-2"><div v-for="item in checklist" :key="item.id" class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition cursor-pointer" @click="toggleCheck(item)"><div class="w-5 h-5 rounded border-2 mr-3 flex items-center justify-center" :class="item.checked ? 'bg-green-500 border-green-500' : 'border-gray-300 bg-white'"><i v-if="item.checked" class="fa-solid fa-check text-white text-xs"></i></div><span :class="{'line-through text-gray-400': item.checked, 'text-gray-700': !item.checked}" class="flex-1 font-medium">{{ item.text }}</span><button @click.stop="deleteChecklistItem(item.id)" class="text-gray-300 hover:text-red-500 px-2 ml-auto"><i class="fa-solid fa-trash"></i></button></div></div><div class="mt-6 flex gap-2"><input v-model="newCheckItem" @keyup.enter="addChecklistItem" placeholder="æ–°å¢å¾…è¾¦äº‹é …..." class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm outline-none focus:border-rome-gold"><button @click="addChecklistItem" class="bg-[#8E3228] text-white w-10 h-10 rounded-lg shadow hover:bg-red-800 transition"><i class="fa-solid fa-plus"></i></button></div></div>
        </main>
        <button v-if="['itinerary', 'expenses'].includes(currentTab)" @click="openModal()" class="fab-btn absolute bottom-24 right-6 w-14 h-14 text-white rounded-full flex items-center justify-center text-xl transition z-30 ring-4 ring-rome-cream" :disabled="!isDataLoaded || isSaving"><i v-if="!isDataLoaded || isSaving" class="fa-solid fa-spinner fa-spin"></i><i v-else class="fa-solid fa-plus"></i></button>
        <nav class="bg-white/95 backdrop-blur border-t border-gray-200 px-6 py-2 flex justify-between items-center z-40 pb-6 shrink-0"><button @click="currentTab = 'itinerary'" class="flex flex-col items-center w-14 group"><i :class="currentTab === 'itinerary' ? 'text-[#8E3228] -translate-y-1' : 'text-gray-300'" class="fa-regular fa-calendar-days text-xl mb-1"></i><span class="text-[10px] font-bold" :class="currentTab === 'itinerary' ? 'text-[#8E3228]' : 'text-gray-300'">è¡Œç¨‹</span></button><button @click="currentTab = 'expenses'" class="flex flex-col items-center w-14 group"><i :class="currentTab === 'expenses' ? 'text-[#8E3228] -translate-y-1' : 'text-gray-300'" class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px] font-bold" :class="currentTab === 'expenses' ? 'text-[#8E3228]' : 'text-gray-300'">å¸³å‹™</span></button><button @click="currentTab = 'map'" class="flex flex-col items-center w-14 group"><i :class="currentTab === 'map' ? 'text-[#8E3228] -translate-y-1' : 'text-gray-300'" class="fa-regular fa-map text-xl mb-1"></i><span class="text-[10px] font-bold" :class="currentTab === 'map' ? 'text-[#8E3228]' : 'text-gray-300'">åœ°åœ–</span></button><button @click="currentTab = 'checklist'" class="flex flex-col items-center w-14 group"><i :class="currentTab === 'checklist' ? 'text-[#8E3228] -translate-y-1' : 'text-gray-300'" class="fa-solid fa-list-check text-xl mb-1"></i><span class="text-[10px] font-bold" :class="currentTab === 'checklist' ? 'text-[#8E3228]' : 'text-gray-300'">æ¸…å–®</span></button></nav>
        <div v-if="showModal" class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm" @click.self="closeModal"><div class="bg-[#fcfbf9] w-full max-w-sm rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up"><h3 class="text-xl font-bold text-[#8E3228] mb-6 text-center">{{ isEditing ? 'ç·¨è¼¯é …ç›®' : (currentTab === 'itinerary' ? 'æ–°å¢è¡Œç¨‹' : 'æ–°å¢æ¶ˆè²»') }}</h3><div v-if="currentTab === 'itinerary'" class="space-y-4"><div class="bg-white p-2 rounded-xl border border-gray-200 flex items-center px-3"><i class="fa-regular fa-calendar text-gray-400 mr-3 w-5 text-center"></i><select v-model="form.date" class="w-full bg-transparent outline-none text-gray-700"><option v-for="d in dates" :value="d.full">{{ d.month }}/{{ d.day }} ({{ d.full }})</option></select></div><div class="bg-white p-2 rounded-xl border border-gray-200 flex items-center px-3"><i class="fa-regular fa-clock text-gray-400 mr-3 w-5 text-center"></i><input v-model="form.time" type="time" class="w-full outline-none bg-transparent"></div><div class="relative"><div class="bg-white p-2 rounded-xl border border-gray-200 flex items-center px-3 relative z-20"><i class="fa-solid fa-location-dot text-gray-400 mr-3 w-5 text-center"></i><input v-model="form.location" @input="onLocationInput" type="text" placeholder="åœ°é» (è¼¸å…¥ä¸­æ–‡è‡ªå‹•æœå°‹)" class="w-full outline-none bg-transparent" autocomplete="off"><i v-if="isSearching" class="fa-solid fa-circle-notch fa-spin text-gray-400"></i></div><ul v-if="suggestions.length > 0" class="suggestions-list"><li v-for="item in suggestions" :key="item.lat + item.lon" @click="selectSuggestion(item)" class="suggestion-item"><div class="font-bold text-gray-800">{{ item.display_name.split(',')[0] }}</div><div class="text-xs text-gray-500 truncate">{{ item.display_name }}</div></li></ul></div><div class="bg-gray-50 p-2 rounded-xl border border-gray-200"><p class="text-[10px] text-gray-400 mb-1 flex justify-between items-center"><span>åº§æ¨™</span><a :href="'http://googleusercontent.com/maps.google.com/search/' + (form.location || 'Rome')" target="_blank" class="text-[#8E3228] hover:underline font-bold text-[10px]"><i class="fa-solid fa-map-location-dot"></i> å» Google Maps æ‰¾åº§æ¨™</a></p><div class="flex gap-2"><input v-model="form.lat" type="text" placeholder="ç·¯åº¦" class="w-1/2 p-1.5 bg-white border rounded text-xs text-center outline-none"><input v-model="form.lng" type="text" placeholder="ç¶“åº¦" class="w-1/2 p-1.5 bg-white border rounded text-xs text-center outline-none"></div></div><textarea v-model="form.note" placeholder="å‚™è¨»äº‹é …..." class="w-full p-3 bg-white border border-gray-200 rounded-xl h-20 outline-none resize-none"></textarea></div><div v-else-if="currentTab === 'expenses'" class="space-y-4"><div class="bg-white p-2 rounded-xl border border-gray-200 flex items-center px-3"><i class="fa-regular fa-calendar text-gray-400 mr-3"></i><select v-model="form.date" class="w-full bg-transparent outline-none"><option v-for="d in dates" :value="d.full">{{ d.month }}/{{ d.day }}</option></select></div><input v-model="form.item" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-3 bg-white border rounded-xl outline-none"><div class="flex gap-2"><div class="relative flex-1"><span class="absolute left-3 top-3 text-gray-500 font-mono">{{ form.currency === 'EUR' ? 'â‚¬' : '$' }}</span><input v-model="form.amount" type="number" placeholder="é‡‘é¡" class="w-full p-3 pl-8 bg-white border rounded-xl outline-none"></div><div class="flex rounded-xl overflow-hidden border border-gray-200"><button @click="form.currency = 'EUR'" class="px-3 py-2 text-sm font-bold transition-colors" :class="form.currency === 'EUR' ? 'bg-[#8E3228] text-white' : 'bg-white text-gray-400'">â‚¬</button><button @click="form.currency = 'TWD'" class="px-3 py-2 text-sm font-bold transition-colors" :class="form.currency === 'TWD' ? 'bg-blue-500 text-white' : 'bg-white text-gray-400'">NT$</button></div></div><div class="flex gap-2 overflow-x-auto no-scrollbar pb-2"><button v-for="cat in ['é£²é£Ÿ','äº¤é€š','é–€ç¥¨','ä½å®¿', 'å…¶ä»–']" @click="form.category = cat" :class="form.category === cat ? 'bg-[#8E3228] text-white' : 'bg-gray-100 text-gray-500'" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition">{{ cat }}</button></div></div><div class="flex space-x-3 mt-8"><button @click="closeModal" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">å–æ¶ˆ</button><button @click="submitForm" class="flex-1 py-3 bg-[#8E3228] text-white font-bold rounded-xl shadow-lg hover:bg-red-800 transition flex justify-center items-center gap-2" :disabled="isSaving"><i v-if="isSaving" class="fa-solid fa-circle-notch fa-spin"></i>{{ isSaving ? 'å„²å­˜ä¸­...' : (isEditing ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªæ–°å¢') }}</button></div></div></div></div>
    <script>
        window.onerror = function(msg, url, line) { document.getElementById('debug-console').style.display = 'block'; document.getElementById('error-msg').innerText += `Error: ${msg}\nLine: ${line}\n`; };
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        const firebaseConfig = { apiKey: "AIzaSyDotF5SMPWJ_gNKCFzH_ACIc8qi1xczd-k", authDomain: "roma-2026.firebaseapp.com", databaseURL: "https://roma-2026-default-rtdb.firebaseio.com", projectId: "roma-2026", storageBucket: "roma-2026.firebasestorage.app", messagingSenderId: "701129098052", appId: "1:701129098052:web:87288ea8be59525b940d11" };
        try { firebase.initializeApp(firebaseConfig); } catch(e) { document.getElementById('debug-console').style.display = 'block'; document.getElementById('error-msg').innerText += e.message; }
        const db = firebase.database();
        createApp({
            setup() {
                const currentTab = ref('itinerary'); const showModal = ref(false); const isEditing = ref(false); const isSearching = ref(false); const isDataLoaded = ref(false); const isSaving = ref(false); const suggestions = ref([]); const searchTimeout = ref(null);
                const itineraryListRef = ref(null); const expenseListRef = ref(null); const sortableInstance = ref(null); const mapInstance = ref(null); const markers = ref([]); const polylines = ref([]);
                const generateDates = () => { const start = new Date('2026-05-19'); const end = new Date('2026-06-02'); let list = []; const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC']; for (let d = start; d <= end; d.setDate(d.getDate() + 1)) { const m = d.getMonth() + 1; const full = d.toISOString().split('T')[0]; list.push({ month: months[d.getMonth()], day: d.getDate(), full: full }); } return list; };
                const dates = ref(generateDates()); const selectedDate = ref('2026-05-19');
                const GEO_DB = { 'ç¾…é¦¬': {lat: 41.902782, lng: 12.496366}, 'ç‰¹ç±³å°¼è»Šç«™': {lat: 41.9009, lng: 12.5020}, 'ç¾…é¦¬æ©Ÿå ´': {lat: 41.8002, lng: 12.2388}, 'ç¾…é¦¬ç«¶æŠ€å ´': {lat: 41.8902102, lng: 12.4922309}, 'æ¢µè’‚å²¡': {lat: 41.902916, lng: 12.453389}, 'è–å½¼å¾—å¤§æ•™å ‚': {lat: 41.902167, lng: 12.453936}, 'è¨±é¡˜æ± ': {lat: 41.900932, lng: 12.483313}, 'è¬ç¥æ®¿': {lat: 41.898611, lng: 12.476873}, 'è¥¿ç­ç‰™å»£å ´': {lat: 41.905698, lng: 12.482327}, 'ç´æ²ƒç´å»£å ´': {lat: 41.899163, lng: 12.473074}, 'çœŸç†ä¹‹å£': {lat: 41.888147, lng: 12.481822}, 'å¨å°¼æ–¯å»£å ´': {lat: 41.895822, lng: 12.482322}, 'è–å¤©ä½¿å ¡': {lat: 41.903064, lng: 12.466276}, 'é‡‘æ¯å’–å•¡': {lat: 41.899133, lng: 12.477213}, 'è€æ©‹å†°æ·‡æ·‹': {lat: 41.906041, lng: 12.456637}, 'ææ‹‰ç±³è˜‡': {lat: 41.882315, lng: 12.511132}, 'å–¬ç«‹å¸å†°æ·‡æ·‹': {lat: 41.901037, lng: 12.478542}, 'é¹¿è§’å’–å•¡': {lat: 41.898333, lng: 12.477222} };
                const itinerary = ref([]); const expenses = ref([]); const checklist = ref([]); const form = ref({ id: null, date: '', time: '', location: '', note: '', item: '', amount: '', category: 'é£²é£Ÿ', currency: 'EUR', lat: '', lng: '' }); const newCheckItem = ref('');
                onMounted(async () => {
                    db.ref('trips/rome2026/itinerary').on('value', (snapshot) => { const data = snapshot.val(); itinerary.value = data ? Object.values(data) : []; isDataLoaded.value = true; if (currentTab.value === 'map') nextTick(() => initMap()); });
                    db.ref('trips/rome2026/expenses').on('value', (s) => expenses.value = s.val() ? Object.values(s.val()) : []);
                    db.ref('trips/rome2026/checklist').on('value', (s) => checklist.value = s.val() ? Object.values(s.val()) : []);
                    await nextTick(); updateSortable();
                });
                const updateOrder = () => { const updates = {}; itinerary.value.forEach(item => updates[`trips/rome2026/itinerary/${item.id}/order`] = item.order); expenses.value.forEach(item => updates[`trips/rome2026/expenses/${item.id}/order`] = item.order); if(Object.keys(updates).length > 0) db.ref().update(updates); };
                const onLocationInput = () => { const query = form.value.location; if (searchTimeout.value) clearTimeout(searchTimeout.value); if (!query || query.length < 1) { suggestions.value = []; return; } searchTimeout.value = setTimeout(async () => { isSearching.value = true; let results = []; for (const key in GEO_DB) { if (key.includes(query) || query.includes(key)) { results.push({ display_name: key + " (å…§å»ºè³‡æ–™)", lat: GEO_DB[key].lat, lon: GEO_DB[key].lng }); } } try { const apiQuery = `${query} Italy`; const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(apiQuery)}&limit=5&accept-language=zh-TW`); const data = await response.json(); if (data) results = [...results, ...data]; } catch (e) { console.error("API Error"); } suggestions.value = results; isSearching.value = false; }, 500); };
                const selectSuggestion = (item) => { form.value.location = item.display_name.split(',')[0]; form.value.lat = parseFloat(item.lat); form.value.lng = parseFloat(item.lon); suggestions.value = []; };
                const currentDayItinerary = computed(() => { return itinerary.value.filter(i => i.date === selectedDate.value).sort((a, b) => (a.order ?? 0) - (b.order ?? 0)); });
                const currentDayExpenses = computed(() => { return expenses.value.filter(e => e.date === selectedDate.value).sort((a, b) => (a.order ?? 0) - (b.order ?? 0)); });
                const dayTotalEUR = computed(() => currentDayExpenses.value.filter(e => e.currency === 'EUR').reduce((sum, e) => sum + Number(e.amount), 0));
                const dayTotalTWD = computed(() => currentDayExpenses.value.filter(e => e.currency === 'TWD').reduce((sum, e) => sum + Number(e.amount), 0));
                const currentFullDateDisplay = computed(() => { const d = dates.value.find(d => d.full === selectedDate.value); return d ? `${d.month} ${d.day}` : ''; });
                const hasEvent = (date) => itinerary.value.some(i => i.date === date);
                const selectDate = (index) => { selectedDate.value = dates.value[index].full; nextTick(() => { const btn = document.getElementById('date-btn-' + index); if (btn) btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' }); }); };
                const updateSortable = () => { if (sortableInstance.value) { sortableInstance.value.destroy(); sortableInstance.value = null; } let el = null; if (currentTab.value === 'itinerary') el = itineraryListRef.value; else if (currentTab.value === 'expenses') el = expenseListRef.value; if (el) { sortableInstance.value = new Sortable(el, { animation: 150, delay: 300, delayOnTouchOnly: false, touchStartThreshold: 5, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', draggable: '.item-card', filter: '.card-actions', onEnd: (evt) => { const list = currentTab.value === 'itinerary' ? currentDayItinerary.value : currentDayExpenses.value; const currentList = [...list]; const [movedItem] = currentList.splice(evt.oldIndex, 1); currentList.splice(evt.newIndex, 0, movedItem); currentList.forEach((item, index) => { const sourceList = currentTab.value === 'itinerary' ? itinerary : expenses; const realItem = sourceList.value.find(i => i.id === item.id); if(realItem) realItem.order = index; }); updateOrder(); } }); } };
                const initMap = () => { const container = document.getElementById('map-container'); if (!container) return; if (mapInstance.value) { mapInstance.value.remove(); mapInstance.value = null; } const map = L.map('map-container').setView([41.9028, 12.4964], 13); L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ maxZoom: 20, attribution: 'Google Maps' }).addTo(map); markers.value = []; polylines.value = []; const bounds = L.latLngBounds(); const pathCoordinates = []; currentDayItinerary.value.forEach((item) => { if (item.lat && item.lng) { const pinIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="custom-pin-icon"></div>`, iconSize: [14, 14], iconAnchor: [7, 7] }); const marker = L.marker([item.lat, item.lng], {icon: pinIcon}).addTo(map).bindPopup(`${item.location}`); markers.value.push(marker); bounds.extend([item.lat, item.lng]); pathCoordinates.push([item.lat, item.lng]); } }); if (pathCoordinates.length > 1) L.polyline(pathCoordinates, { color: '#8E3228', weight: 3, opacity: 0.7, dashArray: '10, 10' }).addTo(map); if (markers.value.length > 0) map.fitBounds(bounds, { padding: [50, 50] }); mapInstance.value = map; };
                const locateMe = () => { if (!mapInstance.value) return; if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(position => { const { latitude, longitude } = position.coords; L.marker([latitude, longitude]).addTo(mapInstance.value).bindPopup("æ‚¨åœ¨é€™è£¡").openPopup(); mapInstance.value.setView([latitude, longitude], 15); }); } };
                watch([selectedDate, currentTab], async () => { await nextTick(); updateSortable(); if (currentTab.value === 'map') setTimeout(() => { initMap(); if(mapInstance.value) mapInstance.value.invalidateSize(); }, 100); });
                
                // ğŸ“ ç·¨è¼¯åŠŸèƒ½ (ç¢ºä¿è¦†è“‹è€Œéæ–°å¢)
                const editItem = (item) => { 
                    isEditing.value = true; 
                    suggestions.value = []; 
                    // æ·±æ‹·è²ï¼Œé¿å…ç›´æ¥æ”¹å‹•é¡¯ç¤º
                    form.value = JSON.parse(JSON.stringify(item)); 
                    showModal.value = true; 
                };
                
                const openModal = () => { isEditing.value = false; suggestions.value = []; form.value = { id: null, date: selectedDate.value, time: '09:00', location: '', note: '', item: '', amount: '', category: 'é£²é£Ÿ', currency: 'EUR', lat: '', lng: '' }; showModal.value = true; };
                const editExpense = (exp) => { isEditing.value = true; form.value = JSON.parse(JSON.stringify(exp)); showModal.value = true; };
                const closeModal = () => { showModal.value = false; isEditing.value = false; isSaving.value = false; };
                const toggleCheck = (item) => { item.checked = !item.checked; db.ref(`trips/rome2026/checklist/${item.id}`).update({checked: item.checked}); };
                const addChecklistItem = () => { if (!newCheckItem.value.trim()) return; const newKey = db.ref().child('trips/rome2026/checklist').push().key; const newItem = { id: newKey, text: newCheckItem.value, checked: false }; db.ref(`trips/rome2026/checklist/${newKey}`).set(newItem); newCheckItem.value = ''; };
                const deleteChecklistItem = (id) => { db.ref(`trips/rome2026/checklist/${id}`).remove(); };
                
                // ğŸ—‘ï¸ åˆªé™¤åŠŸèƒ½ (ç„¡ confirmï¼Œç›´æ¥åŸ·è¡Œ)
                const deleteItem = (id, type) => { 
                    if (!id) return;
                    // 1. ç•«é¢å…ˆç§»é™¤ (æ¨‚è§€ UI æ›´æ–°)
                    if(type === 'itinerary') itinerary.value = itinerary.value.filter(i => i.id !== id);
                    else expenses.value = expenses.value.filter(i => i.id !== id);
                    // 2. ä¼ºæœå™¨åŒæ­¥åˆªé™¤
                    db.ref(`trips/rome2026/${type}/${id}`).remove();
                };

                // ğŸ’¾ å„²å­˜é‚è¼¯ (åŒ…å«æ–°å¢èˆ‡ä¿®æ”¹)
                const submitForm = async () => {
                    isSaving.value = true;
                    try {
                        const targetRef = currentTab.value === 'itinerary' ? 'itinerary' : 'expenses';
                        let itemId = form.value.id;
                        
                        if (!isEditing.value) {
                            const newRef = db.ref(`trips/rome2026/${targetRef}`).push();
                            itemId = newRef.key;
                        }

                        // ç¢ºä¿ ID æ­£ç¢ºï¼Œä¸¦ä¿ç•™åŸå§‹é †åº (è‹¥ç‚ºç·¨è¼¯) æˆ–æ–°å¢åˆ°æœ€å¾Œ
                        const itemToSave = {
                            ...form.value,
                            id: itemId,
                            order: form.value.order ?? (currentTab.value === 'itinerary' ? currentDayItinerary.value.length : currentDayExpenses.value.length)
                        };
                        
                        // è¡Œç¨‹ç„¡å¤©æ°£è³‡æ–™æ™‚çš„é è¨­å€¼
                        if (currentTab.value === 'itinerary' && !itemToSave.weather) {
                            itemToSave.weather = null;
                        }

                        // å¯«å…¥è³‡æ–™åº« (update æœƒè¦†è“‹åŒ ID è³‡æ–™)
                        await db.ref(`trips/rome2026/${targetRef}/${itemId}`).update(itemToSave);
                        closeModal();
                    } catch (e) {
                        alert("å„²å­˜å¤±æ•—: " + e.message);
                    } finally {
                        isSaving.value = false;
                    }
                };

                const getWeatherIcon = (code) => { if (code <= 1) return 'fa-solid fa-sun text-yellow-500'; if (code <= 3) return 'fa-solid fa-cloud-sun text-gray-400'; return 'fa-solid fa-cloud-rain text-blue-400'; };
                const getCategoryIcon = (cat) => { const map = { 'é£²é£Ÿ': 'fa-utensils', 'äº¤é€š': 'fa-train-subway', 'é–€ç¥¨': 'fa-ticket', 'ä½å®¿': 'fa-bed', 'å…¶ä»–': 'fa-star' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };

                return {
                    currentTab, showModal, isEditing, isSearching, isDataLoaded, isSaving, suggestions, form, dates, selectedDate, selectDate,
                    currentDayItinerary, currentDayExpenses, dayTotalEUR, dayTotalTWD,
                    itinerary, expenses, checklist, newCheckItem, hasEvent, itineraryListRef, expenseListRef,
                    openModal, editItem, editExpense, submitForm, closeModal, deleteItem, toggleCheck, addChecklistItem, deleteChecklistItem,
                    getWeatherIcon, getCategoryIcon, locateMe, currentFullDateDisplay, onLocationInput, selectSuggestion
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
