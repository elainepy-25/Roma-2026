<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å—ç¾©ä¹‹æ—… (V32 ç´”æ·¨å–®æ©Ÿç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0e6d2; overscroll-behavior: none; -webkit-user-select: none; user-select: none; }
        h1, h2, .roman-font { font-family: 'Cinzel', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .bg-rome-sketch {
            background-image: url('https://img.freepik.com/free-vector/hand-drawn-rome-landmark-pattern_23-2149463959.jpg');
            background-size: 400px; background-blend-mode: overlay; opacity: 0.15; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;
        }

        .sortable-ghost { opacity: 0.2; background-color: #ef4444; border: 2px dashed #8E3228; }
        .sortable-drag { cursor: grabbing !important; opacity: 1; background: white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); transform: scale(1.02); z-index: 9999; }
        .item-card { cursor: grab; transition: transform 0.1s; position: relative; }
        .item-card:active { cursor: grabbing; }

        #map-container { z-index: 1; height: 100%; width: 100%; border-radius: 0.75rem; }
        
        /* ğŸ”¥ ä¿®æ”¹ 1: åœ°åœ–é‡˜é¸æ”¹ç‚ºç´”ç´…é» (ç„¡æ•¸å­—) */
        .custom-pin-icon {
            background-color: #8E3228; 
            width: 14px; height: 14px;
            border-radius: 50%; border: 2px solid white;
            box-shadow: 0 0 0 2px rgba(142, 50, 40, 0.3), 0 3px 6px rgba(0,0,0,0.4);
        }

        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; font-family: 'Noto Sans TC'; min-width: 200px; }
        .popup-header { background: #8E3228; color: white; padding: 8px 12px; font-size: 14px; font-weight: bold; }
        .popup-body { padding: 12px; font-size: 13px; color: #4b5563; }
        .popup-btn { display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; background: #2563eb; color: white; padding: 8px; margin-top: 8px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 12px; transition: background 0.2s; }
        
        .date-active { background-color: #8E3228 !important; border-color: #8E3228 !important; color: white !important; transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .date-inactive { background-color: white; color: #6b7280; border-color: #e5e7eb; }
        .fab-btn { background-color: #8E3228; box-shadow: 0 10px 20px -5px rgba(127, 29, 29, 0.5); border: 2px solid white; }
        .fab-btn:active { background-color: #450a0a; transform: scale(0.95); }
        
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; max-height: 200px; overflow-y: auto; }
        .suggestion-item { padding: 0.75rem 1rem; font-size: 0.875rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
        .suggestion-item:hover { background-color: #fff1f2; color: #8E3228; }

        .btn-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; cursor: pointer; }
        .btn-edit:hover { background-color: #f3f4f6; color: #8E3228; }
        .btn-delete:hover { background-color: #fee2e2; color: #dc2626; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col items-center justify-center bg-[#e5e5e5]">

    <div id="app" class="w-full max-w-md h-full sm:h-[95vh] sm:rounded-3xl sm:border-4 sm:border-white sm:shadow-2xl flex flex-col relative bg-[#f5f0e6] overflow-hidden" v-cloak>
        <div class="bg-rome-sketch"></div>
        
        <header class="bg-gradient-to-r from-[#8E3228] to-[#5e211a] text-white p-5 pt-8 shadow-lg z-20 flex justify-between items-center rounded-b-3xl shrink-0">
            <div>
                <div class="text-[10px] text-rome-gold tracking-[0.3em] uppercase mb-1 font-bold">Buongiorno</div>
                <h1 class="text-2xl font-bold tracking-wide flex items-center gap-2">
                    <i class="fa-solid fa-crown text-rome-gold text-lg"></i> 2026 å—ç¾©ä¹‹æ—…
                </h1>
                <div class="text-[10px] opacity-80 mt-1"><i class="fa-solid fa-mobile-screen mr-1"></i>å–®æ©Ÿç‰ˆ</div>
            </div>
            <div class="w-12 h-12 rounded-full border-2 border-rome-gold bg-rome-cream shadow-md flex items-center justify-center text-2xl">ğŸ¦</div>
        </header>

        <div v-if="['itinerary', 'expenses'].includes(currentTab)" class="bg-white/80 backdrop-blur-md py-3 shadow-sm z-10 border-b border-rome-gold/20 shrink-0">
            <div class="flex overflow-x-auto no-scrollbar px-4 space-x-3 snap-x" id="date-scroll-container">
                <button v-for="(date, index) in dates" :key="date.full" :id="'date-btn-' + index" @click="selectDate(index)"
                    class="flex-shrink-0 snap-center flex flex-col items-center justify-center w-14 h-16 rounded-2xl border transition-all duration-300 relative overflow-hidden"
                    :class="selectedDate === date.full ? 'date-active' : 'date-inactive'">
                    <span class="text-[9px] uppercase font-bold tracking-wider opacity-80">{{ date.month }}</span>
                    <span class="text-xl font-bold font-mono">{{ date.day }}</span>
                    <div v-if="hasEvent(date.full)" class="absolute bottom-1 w-1 h-1 rounded-full" :class="selectedDate === date.full ? 'bg-white' : 'bg-red-800'"></div>
                </button>
            </div>
        </div>

        <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-28 relative scroll-smooth bg-transparent">
            
            <div v-show="currentTab === 'itinerary'" class="animate-[fadeIn_0.3s_ease-out]">
                <div class="text-center mb-2">
                    <span class="text-[10px] text-gray-500 bg-white/50 px-3 py-1 rounded-full shadow-sm">
                        <i class="fa-solid fa-arrows-up-down mr-1"></i> é•·æŒ‰å¯æ‹–æ›³æ’åº
                    </span>
                </div>
                <div ref="itineraryListRef" class="space-y-4 pb-20 min-h-[200px]">
                    <div v-for="(item, index) in currentDayItinerary" :key="item.id" :data-id="item.id"
                         class="item-card group relative bg-white/95 backdrop-blur rounded-xl shadow-sm border-l-4 border-rome-gold overflow-hidden flex items-stretch">
                        <div class="p-4 pl-3 flex-1">
                            <div class="flex justify-between items-start mb-2 pr-2">
                                <div class="flex items-center gap-2">
                                    <span class="bg-gray-100 text-gray-700 px-2 py-0.5 rounded text-sm font-bold font-mono">{{ item.time }}</span>
                                    <div v-if="item.weather" class="flex items-center gap-1 text-xs text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full">
                                        <i :class="getWeatherIcon(item.weather.code)"></i> {{ item.weather.temp }}Â°C
                                    </div>
                                </div>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 leading-tight pr-4">{{ item.location }}</h3>
                            <p class="text-sm text-gray-500 mt-1 line-clamp-2 pr-4">{{ item.note }}</p>
                            <a :href="`http://googleusercontent.com/maps.google.com/search/${encodeURIComponent(item.location + ' Italy')}`" target="_blank" class="mt-2 inline-flex items-center text-xs font-bold text-[#8E3228] hover:underline">
                                <i class="fa-solid fa-location-arrow mr-1"></i> å°èˆª
                            </a>
                        </div>
                        <div class="bg-gray-50 w-12 flex flex-col justify-center items-center gap-2 border-l border-gray-200">
                            <button @click.stop="editItem(item)" class="btn-icon btn-edit"><i class="fa-solid fa-pen text-sm"></i></button>
                            <button @click.stop="deleteItem(item.id, 'itinerary')" class="btn-icon btn-delete"><i class="fa-solid fa-trash text-sm"></i></button>
                        </div>
                    </div>
                </div>
                <div v-if="currentDayItinerary.length === 0" class="text-center py-10 text-gray-400 text-sm">æœ¬æ—¥å°šç„¡è¡Œç¨‹ï¼Œé»æ“Š + æ–°å¢</div>
            </div>

            <div v-show="currentTab === 'expenses'" class="animate-[fadeIn_0.3s_ease-out]">
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 text-white rounded-2xl p-4 shadow-lg mb-4">
                    <div class="flex divide-x divide-gray-600">
                        <div class="flex-1 pr-4">
                            <p class="text-[10px] text-gray-400 uppercase">Euro</p>
                            <div class="text-2xl font-bold font-mono text-rome-gold">â‚¬{{ dayTotalEUR }}</div>
                        </div>
                        <div class="flex-1 pl-4">
                            <p class="text-[10px] text-gray-400 uppercase">TWD</p>
                            <div class="text-2xl font-bold font-mono text-blue-300">NT${{ dayTotalTWD }}</div>
                        </div>
                    </div>
                </div>
                <div ref="expenseListRef" class="space-y-3 pb-20 min-h-[100px]">
                    <div v-for="exp in currentDayExpenses" :key="exp.id" :data-id="exp.id"
                         class="item-card group relative bg-white/90 p-4 rounded-xl shadow-sm flex items-center border-l-4"
                         :class="exp.currency === 'EUR' ? 'border-rome-gold' : 'border-blue-400'"
                         @click="editExpense(exp)">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-lg shrink-0" :class="exp.currency === 'EUR' ? 'text-rome-gold' : 'text-blue-500'">
                                <i :class="getCategoryIcon(exp.category)"></i>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800 text-sm">{{ exp.item }}</div>
                                <div class="text-[10px] text-gray-400">{{ exp.category }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 pr-2">
                            <span class="font-bold font-mono text-sm" :class="exp.currency === 'EUR' ? 'text-gray-800' : 'text-blue-600'">{{ exp.currency === 'EUR' ? 'â‚¬' : 'NT$' }}{{ exp.amount }}</span>
                            <button @click.stop="deleteItem(exp.id, 'expenses')" class="btn-icon btn-delete"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>
                <div v-if="currentDayExpenses.length === 0" class="text-center py-10 text-gray-400 text-sm">æœ¬æ—¥æ²’æœ‰æ¶ˆè²»ç´€éŒ„ ğŸ’°</div>
            </div>

            <div v-show="currentTab === 'map'" class="h-full flex flex-col gap-3 animate-[fadeIn_0.3s_ease-out]">
                <div class="bg-white/95 backdrop-blur rounded-xl p-3 shadow-sm border-l-4 border-rome-gold flex justify-between items-center z-10">
                    <div>
                        <h2 class="font-bold text-gray-800 text-sm"><i class="fa-solid fa-map-pin text-rome-red mr-2"></i>{{ currentFullDateDisplay }} è¡Œç¨‹è·¯å¾‘</h2>
                        <p class="text-[10px] text-gray-500">å·²é‡˜é¸ {{ currentDayItinerary.length }} å€‹åœ°é»</p>
                    </div>
                    <button @click="locateMe" class="bg-white text-blue-500 border border-blue-500 text-xs px-3 py-1.5 rounded-full shadow hover:bg-blue-50 transition flex items-center gap-1"><i class="fa-solid fa-location-crosshairs"></i> å®šä½</button>
                </div>
                <div id="map-container" class="flex-1 shadow-inner relative overflow-hidden bg-gray-200 border border-gray-300"></div>
            </div>

            <div v-show="currentTab === 'checklist'" class="bg-white/90 p-5 rounded-xl shadow-sm min-h-[300px]">
               <h2 class="text-xl font-bold text-[#8E3228] mb-4 roman-font border-b pb-2 border-gray-100">è¡Œå‰æº–å‚™æ¸…å–®</h2>
               <div class="space-y-2">
                   <div v-for="item in checklist" :key="item.id" class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition cursor-pointer" @click="toggleCheck(item)">
                       <div class="w-5 h-5 rounded border-2 mr-3 flex items-center justify-center" :class="item.checked ? 'bg-green-500 border-green-500' : 'border-gray-300 bg-white'">
                           <i v-if="item.checked" class="fa-solid fa-check text-white text-xs"></i>
                       </div>
                       <span :class="{'line-through text-gray-400': item.checked, 'text-gray-700': !item.checked}" class="flex-1 font-medium">{{ item.text }}</span>
                       <button @click.stop="deleteChecklistItem(item.id)" class="text-gray-300 hover:text-red-500 px-2 ml-auto"><i class="fa-solid fa-trash"></i></button>
                   </div>
               </div>
               <div class="mt-6 flex gap-2">
                   <input v-model="newCheckItem" @keyup.enter="addChecklistItem" placeholder="æ–°å¢å¾…è¾¦äº‹é …..." class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm outline-none focus:border-rome-gold">
                   <button @click="addChecklistItem" class="bg-[#8E3228] text-white w-10 h-10 rounded-lg shadow hover:bg-red-800 transition"><i class="fa-solid fa-plus"></i></button>
               </div>
            </div>
        </main>

        <button v-if="['itinerary', 'expenses'].includes(currentTab)" @click="openModal()" class="fab-btn absolute bottom-24 right-6 w-14 h-14 text-white rounded-full flex items-center justify-center text-xl transition z-30 ring-4 ring-rome-cream">
            <i class="fa-solid fa-plus"></i>
        </button>

        <nav class="bg-white/95 backdrop-blur border-t border-gray-200 px-6 py-2 flex justify-between items-center z-40 pb-6 shrink-0">
            <button @click="currentTab = 'itinerary'" class="flex flex-col items-center w-14 transition-all duration-300 group"><i :class="currentTab === 'itinerary' ? 'text-[#8E3228] -translate-y-1' : 'text-gray-300'" class="fa-regular fa-calendar-days text-xl mb-1 transition-transform"></i><span class="text-[10px] font-bold" :class="currentTab === 'itinerary' ? 'text-[#8E3228]' : 'text-gray-300'">è¡Œç¨‹</span></button>
            <button @click="currentTab = 'expenses'" class="flex flex-col items-center w-14 transition-all duration-300 group"><i :class="currentTab === 'expenses' ? 'text-[#8E3228] -translate-y-1' : 'text-gray-300'" class="fa-solid fa-wallet text-xl mb-1 transition-transform"></i><span class="text-[10px] font-bold" :class="currentTab === 'expenses' ? 'text-[#8E3228]' : 'text-gray-300'">å¸³å‹™</span></button>
            <button @click="currentTab = 'map'" class="flex flex-col items-center w-14 transition-all duration-300 group"><i :class="currentTab === 'map' ? 'text-[#8E3228] -translate-y-1' : 'text-gray-300'" class="fa-regular fa-map text-xl mb-1 transition-transform"></i><span class="text-[10px] font-bold" :class="currentTab === 'map' ? 'text-[#8E3228]' : 'text-gray-300'">åœ°åœ–</span></button>
            <button @click="currentTab = 'checklist'" class="flex flex-col items-center w-14 transition-all duration-300 group"><i :class="currentTab === 'checklist' ? 'text-[#8E3228] -translate-y-1' : 'text-gray-300'" class="fa-solid fa-list-check text-xl mb-1 transition-transform"></i><span class="text-[10px] font-bold" :class="currentTab === 'checklist' ? 'text-[#8E3228]' : 'text-gray-300'">æ¸…å–®</span></button>
        </nav>

        <div v-if="showModal" class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm" @click.self="closeModal">
            <div class="bg-[#fcfbf9] w-full max-w-sm rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold text-[#8E3228] mb-6 roman-font text-center">{{ isEditing ? 'ç·¨è¼¯é …ç›®' : (currentTab === 'itinerary' ? 'æ–°å¢è¡Œç¨‹' : 'æ–°å¢æ¶ˆè²»') }}</h3>
                <div v-if="currentTab === 'itinerary'" class="space-y-4">
                    <div class="bg-white p-2 rounded-xl border border-gray-200 flex items-center px-3"><i class="fa-regular fa-calendar text-gray-400 mr-3 w-5 text-center"></i><select v-model="form.date" class="w-full bg-transparent outline-none text-gray-700"><option v-for="d in dates" :value="d.full">{{ d.month }}/{{ d.day }} ({{ d.full }})</option></select></div>
                    <div class="bg-white p-2 rounded-xl border border-gray-200 flex items-center px-3"><i class="fa-regular fa-clock text-gray-400 mr-3 w-5 text-center"></i><input v-model="form.time" type="time" class="w-full outline-none bg-transparent"></div>
                    <div class="relative">
                        <div class="bg-white p-2 rounded-xl border border-gray-200 flex items-center px-3 relative z-20"><i class="fa-solid fa-location-dot text-gray-400 mr-3 w-5 text-center"></i><input v-model="form.location" @input="onLocationInput" type="text" placeholder="åœ°é» (è¼¸å…¥ä¸­æ–‡è‡ªå‹•æœå°‹)" class="w-full outline-none bg-transparent" autocomplete="off"><i v-if="isSearching" class="fa-solid fa-circle-notch fa-spin text-gray-400"></i></div>
                        <ul v-if="suggestions.length > 0" class="suggestions-list"><li v-for="item in suggestions" :key="item.lat + item.lon" @click="selectSuggestion(item)" class="suggestion-item"><div class="font-bold text-gray-800">{{ item.display_name.split(',')[0] }}</div><div class="text-xs text-gray-500 truncate">{{ item.display_name }}</div></li></ul>
                    </div>
                    <div class="bg-gray-50 p-2 rounded-xl border border-gray-200">
                        <p class="text-[10px] text-gray-400 mb-1 flex justify-between items-center"><span>åº§æ¨™ (è‡ªå‹•å¡«å…¥/æ‰‹å‹•æ ¡æ­£)</span><a :href="'http://googleusercontent.com/maps.google.com/search/' + (form.location || 'Rome')" target="_blank" class="text-[#8E3228] hover:underline font-bold text-[10px]"><i class="fa-solid fa-map-location-dot"></i> å» Google Maps æ‰¾åº§æ¨™</a></p>
                        <div class="flex gap-2"><input v-model="form.lat" type="text" placeholder="ç·¯åº¦" class="w-1/2 p-1.5 bg-white border rounded text-xs text-center outline-none"><input v-model="form.lng" type="text" placeholder="ç¶“åº¦" class="w-1/2 p-1.5 bg-white border rounded text-xs text-center outline-none"></div>
                    </div>
                    <textarea v-model="form.note" placeholder="å‚™è¨»äº‹é …..." class="w-full p-3 bg-white border border-gray-200 rounded-xl h-20 outline-none resize-none"></textarea>
                </div>
                <div v-else-if="currentTab === 'expenses'" class="space-y-4">
                    <div class="bg-white p-2 rounded-xl border border-gray-200 flex items-center px-3"><i class="fa-regular fa-calendar text-gray-400 mr-3"></i><select v-model="form.date" class="w-full bg-transparent outline-none"><option v-for="d in dates" :value="d.full">{{ d.month }}/{{ d.day }}</option></select></div>
                    <input v-model="form.item" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-3 bg-white border rounded-xl outline-none">
                    <div class="flex gap-2"><div class="relative flex-1"><span class="absolute left-3 top-3 text-gray-500 font-mono">{{ form.currency === 'EUR' ? 'â‚¬' : '$' }}</span><input v-model="form.amount" type="number" placeholder="é‡‘é¡" class="w-full p-3 pl-8 bg-white border rounded-xl outline-none"></div><div class="flex rounded-xl overflow-hidden border border-gray-200"><button @click="form.currency = 'EUR'" class="px-3 py-2 text-sm font-bold transition-colors" :class="form.currency === 'EUR' ? 'bg-[#8E3228] text-white' : 'bg-white text-gray-400'">â‚¬</button><button @click="form.currency = 'TWD'" class="px-3 py-2 text-sm font-bold transition-colors" :class="form.currency === 'TWD' ? 'bg-blue-500 text-white' : 'bg-white text-gray-400'">NT$</button></div></div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2"><button v-for="cat in ['é£²é£Ÿ','äº¤é€š','é–€ç¥¨','ä½å®¿', 'å…¶ä»–']" @click="form.category = cat" :class="form.category === cat ? 'bg-[#8E3228] text-white' : 'bg-gray-100 text-gray-500'" class="px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition">{{ cat }}</button></div>
                </div>
                <div class="flex space-x-3 mt-8">
                    <button @click="closeModal" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">å–æ¶ˆ</button>
                    <button @click="submitForm" class="flex-1 py-3 bg-[#8E3228] text-white font-bold rounded-xl shadow-lg hover:bg-red-800 transition flex justify-center items-center gap-2">{{ isEditing ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªæ–°å¢' }}</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const showModal = ref(false);
                const isEditing = ref(false);
                const isSearching = ref(false);
                const suggestions = ref([]);
                const searchTimeout = ref(null);
                
                const itineraryListRef = ref(null);
                const expenseListRef = ref(null);
                const sortableInstance = ref(null);
                const mapInstance = ref(null);
                const markers = ref([]);
                const polylines = ref([]);

                const KEYS = {
                    ITINERARY: 'rome2026_local_itinerary',
                    EXPENSES: 'rome2026_local_expenses',
                    CHECKLIST: 'rome2026_local_checklist'
                };

                const generateDates = () => {
                    const start = new Date('2026-05-19');
                    const end = new Date('2026-06-02');
                    let list = [];
                    const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
                    for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                        const m = d.getMonth() + 1;
                        const full = d.toISOString().split('T')[0];
                        list.push({ month: months[d.getMonth()], day: d.getDate(), full: full });
                    }
                    return list;
                };

                const dates = ref(generateDates());
                const selectedDate = ref('2026-05-19');
                
                // ç¹é«”ä¸­æ–‡æ™¯é»åº«
                const GEO_DB = {
                    'ç¾…é¦¬': {lat: 41.902782, lng: 12.496366}, 'ç‰¹ç±³å°¼è»Šç«™': {lat: 41.9009, lng: 12.5020},
                    'ç¾…é¦¬æ©Ÿå ´': {lat: 41.8002, lng: 12.2388}, 'ç¾…é¦¬ç«¶æŠ€å ´': {lat: 41.8902102, lng: 12.4922309},
                    'æ¢µè’‚å²¡': {lat: 41.902916, lng: 12.453389}, 'è–å½¼å¾—å¤§æ•™å ‚': {lat: 41.902167, lng: 12.453936},
                    'è¨±é¡˜æ± ': {lat: 41.900932, lng: 12.483313}, 'è¬ç¥æ®¿': {lat: 41.898611, lng: 12.476873},
                    'è¥¿ç­ç‰™å»£å ´': {lat: 41.905698, lng: 12.482327}, 'ç´æ²ƒç´å»£å ´': {lat: 41.899163, lng: 12.473074},
                    'çœŸç†ä¹‹å£': {lat: 41.888147, lng: 12.481822}, 'å¨å°¼æ–¯å»£å ´': {lat: 41.895822, lng: 12.482322},
                    'è–å¤©ä½¿å ¡': {lat: 41.903064, lng: 12.466276}, 'é‡‘æ¯å’–å•¡': {lat: 41.899133, lng: 12.477213},
                    'è€æ©‹å†°æ·‡æ·‹': {lat: 41.906041, lng: 12.456637}, 'ææ‹‰ç±³è˜‡': {lat: 41.882315, lng: 12.511132},
                    'å–¬ç«‹å¸å†°æ·‡æ·‹': {lat: 41.901037, lng: 12.478542}, 'é¹¿è§’å’–å•¡': {lat: 41.898333, lng: 12.477222}
                };

                const itinerary = ref([
                    { id: 1, date: '2026-05-19', time: '18:30', location: 'ç¾…é¦¬æ©Ÿå ´ (FCO)', note: 'æ­ä¹˜ Leonardo Express', lat: 41.8002778, lng: 12.2388889, weather: null, order: 0 },
                    { id: 2, date: '2026-05-19', time: '20:00', location: 'Hotel Artemide (Termini)', note: 'Check-in', lat: 41.901505, lng: 12.493902, weather: null, order: 1 }
                ]);
                
                const expenses = ref([
                    { id: 101, date: '2026-05-19', item: 'æ©Ÿå ´å¿«ç·š', amount: 14, category: 'äº¤é€š', currency: 'EUR', order: 0 }
                ]);

                const checklist = ref([
                    { id: 1, text: 'è­·ç…§èˆ‡ç°½è­‰å½±æœ¬', checked: true },
                    { id: 2, text: 'è¬ç”¨è½‰æ¥é ­', checked: false }
                ]);

                const form = ref({ id: null, date: '', time: '', location: '', note: '', item: '', amount: '', category: 'é£²é£Ÿ', currency: 'EUR', lat: '', lng: '' });
                const newCheckItem = ref('');

                onMounted(async () => {
                    const savedIt = localStorage.getItem(KEYS.ITINERARY); 
                    const savedExp = localStorage.getItem(KEYS.EXPENSES); 
                    const savedChk = localStorage.getItem(KEYS.CHECKLIST);
                    if (savedIt) itinerary.value = JSON.parse(savedIt); 
                    if (savedExp) expenses.value = JSON.parse(savedExp); 
                    if (savedChk) checklist.value = JSON.parse(savedChk);
                    itinerary.value.forEach(fetchWeather);
                    await nextTick();
                    updateSortable();
                });

                const saveData = () => { 
                    localStorage.setItem(KEYS.ITINERARY, JSON.stringify(itinerary.value)); 
                    localStorage.setItem(KEYS.EXPENSES, JSON.stringify(expenses.value)); 
                    localStorage.setItem(KEYS.CHECKLIST, JSON.stringify(checklist.value)); 
                };

                const onLocationInput = () => {
                    const query = form.value.location;
                    if (searchTimeout.value) clearTimeout(searchTimeout.value);
                    if (!query || query.length < 1) { suggestions.value = []; return; }

                    searchTimeout.value = setTimeout(async () => {
                        isSearching.value = true;
                        let results = [];
                        for (const key in GEO_DB) {
                            if (key.includes(query) || query.includes(key)) {
                                results.push({ display_name: key + " (å…§å»ºè³‡æ–™)", lat: GEO_DB[key].lat, lon: GEO_DB[key].lng });
                            }
                        }
                        try {
                            const apiQuery = `${query} Italy`; 
                            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(apiQuery)}&limit=5&accept-language=zh-TW`);
                            const data = await response.json();
                            if (data) results = [...results, ...data];
                        } catch (e) { console.error("API Error"); }
                        suggestions.value = results;
                        isSearching.value = false;
                    }, 500);
                };

                // ğŸ”¥ ä¿®æ”¹ 3: å¼·åˆ¶è¦†è“‹åç¨±
                const selectSuggestion = (item) => {
                    form.value.location = item.display_name.split(',')[0]; // å¼·åˆ¶ä½¿ç”¨å»ºè­°åç¨±
                    form.value.lat = parseFloat(item.lat);
                    form.value.lng = parseFloat(item.lon);
                    suggestions.value = [];
                };

                const currentDayItinerary = computed(() => {
                    return itinerary.value.filter(i => i.date === selectedDate.value).sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
                });

                const currentDayExpenses = computed(() => {
                    return expenses.value.filter(e => e.date === selectedDate.value).sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
                });
                
                const dayTotalEUR = computed(() => currentDayExpenses.value.filter(e => e.currency === 'EUR').reduce((sum, e) => sum + Number(e.amount), 0));
                const dayTotalTWD = computed(() => currentDayExpenses.value.filter(e => e.currency === 'TWD').reduce((sum, e) => sum + Number(e.amount), 0));
                const allTotalEUR = computed(() => expenses.value.filter(e => e.currency === 'EUR').reduce((sum, e) => sum + Number(e.amount), 0));
                const allTotalTWD = computed(() => expenses.value.filter(e => e.currency === 'TWD').reduce((sum, e) => sum + Number(e.amount), 0));
                
                const currentFullDateDisplay = computed(() => {
                    const d = dates.value.find(d => d.full === selectedDate.value);
                    return d ? `${d.month} ${d.day}` : '';
                });

                const hasEvent = (date) => itinerary.value.some(i => i.date === date);

                const selectDate = (index) => {
                    selectedDate.value = dates.value[index].full;
                    nextTick(() => {
                        const btn = document.getElementById('date-btn-' + index);
                        if (btn) btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    });
                };

                const updateSortable = () => {
                    if (sortableInstance.value) { sortableInstance.value.destroy(); sortableInstance.value = null; }
                    let el = null, listRef = null, globalDataRef = null;
                    if (currentTab.value === 'itinerary') { el = itineraryListRef.value; listRef = currentDayItinerary; globalDataRef = itinerary; } 
                    else if (currentTab.value === 'expenses') { el = expenseListRef.value; listRef = currentDayExpenses; globalDataRef = expenses; }

                    if (el) {
                        sortableInstance.value = new Sortable(el, {
                            animation: 150, delay: 300, delayOnTouchOnly: false, touchStartThreshold: 5,
                            ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                            onEnd: (evt) => {
                                const currentList = [...listRef.value];
                                const [movedItem] = currentList.splice(evt.oldIndex, 1);
                                currentList.splice(evt.newIndex, 0, movedItem);
                                currentList.forEach((item, index) => {
                                    const realItem = globalDataRef.value.find(i => i.id === item.id);
                                    if(realItem) realItem.order = index;
                                });
                                saveData();
                                if(currentTab.value === 'itinerary') {
                                    setTimeout(() => { mapInstance.value && initMap() }, 50); 
                                }
                            }
                        });
                    }
                };

                const initMap = () => {
                    const container = document.getElementById('map-container');
                    if (!container) return;
                    if (mapInstance.value) { mapInstance.value.remove(); mapInstance.value = null; }

                    const map = L.map('map-container').setView([41.9028, 12.4964], 13);
                    L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ maxZoom: 20, attribution: 'Google Maps' }).addTo(map);

                    markers.value = [];
                    polylines.value = [];
                    const bounds = L.latLngBounds();
                    const pathCoordinates = [];
                    
                    currentDayItinerary.value.forEach((item) => {
                        if (item.lat && item.lng && item.lat !== '' && item.lng !== '') {
                            // ğŸ”¥ ä¿®æ”¹ 1: ä½¿ç”¨ç´”ç´…é» Icon
                            const pinIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="custom-pin-icon"></div>`, iconSize: [14, 14], iconAnchor: [7, 7] });
                            const marker = L.marker([item.lat, item.lng], {icon: pinIcon}).addTo(map)
                                .bindPopup(`
                                    <div class="popup-header"><span>${item.location}</span><span style="font-size:12px;opacity:0.8">${item.time}</span></div>
                                    <div class="popup-body">${item.note || ''}<a href="http://googleusercontent.com/maps.google.com/search/${encodeURIComponent(item.location + ' Italy')}" target="_blank" class="popup-btn"><i class="fa-solid fa-location-arrow"></i> Google å°èˆª</a></div>
                                `);
                            markers.value.push(marker);
                            bounds.extend([item.lat, item.lng]);
                            pathCoordinates.push([item.lat, item.lng]);
                        }
                    });

                    if (pathCoordinates.length > 1) {
                        L.polyline(pathCoordinates, { color: '#8E3228', weight: 3, opacity: 0.7, dashArray: '10, 10' }).addTo(map);
                    }

                    if (markers.value.length > 0) { map.fitBounds(bounds, { padding: [50, 50] }); }
                    mapInstance.value = map;
                };

                const locateMe = () => {
                    if (!mapInstance.value) return;
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            const { latitude, longitude } = position.coords;
                            const isFar = Math.abs(latitude - 41.9) > 5;
                            L.marker([latitude, longitude], {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: `<div style="background-color:#3b82f6;width:14px;height:14px;border-radius:50%;border:2px solid white;box-shadow:0 0 0 3px rgba(59,130,246,0.3);"></div>`,
                                    iconSize: [14, 14], iconAnchor: [7, 7]
                                })
                            }).addTo(mapInstance.value).bindPopup(isFar ? "æ‚¨åœ¨å°ç£" : "æ‚¨åœ¨é€™è£¡").openPopup();
                            if (!isFar) { mapInstance.value.setView([latitude, longitude], 15); } 
                            else { alert("å·²æ¨™ç¤ºæ‚¨çš„ä½ç½®ã€‚å› è·é›¢éé ï¼Œåœ°åœ–å°‡ä¿æŒåœ¨ç¾…é¦¬è¡Œç¨‹ç¯„åœã€‚"); }
                        }, () => { alert("ç„¡æ³•å–å¾—ä½ç½®"); });
                    }
                };

                watch([selectedDate, currentTab], async () => {
                    await nextTick();
                    updateSortable();
                    if (currentTab.value === 'map') {
                        setTimeout(() => {
                            initMap(); 
                            if(mapInstance.value) mapInstance.value.invalidateSize();
                        }, 100);
                    }
                });

                const openModal = () => { 
                    isEditing.value = false; 
                    suggestions.value = [];
                    form.value = { id: null, date: selectedDate.value, time: '09:00', location: '', note: '', item: '', amount: '', category: 'é£²é£Ÿ', currency: 'EUR', lat: '', lng: '' }; 
                    showModal.value = true; 
                };
                const editItem = (item) => { isEditing.value = true; suggestions.value = []; form.value = { ...item }; showModal.value = true; };
                const editExpense = (exp) => { isEditing.value = true; form.value = { ...exp }; showModal.value = true; };
                const closeModal = () => { showModal.value = false; isEditing.value = false; };
                const toggleCheck = (item) => { item.checked = !item.checked; saveData(); };
                const addChecklistItem = () => { if (!newCheckItem.value.trim()) return; checklist.value.push({ id: Date.now(), text: newCheckItem.value, checked: false }); newCheckItem.value = ''; saveData(); };
                const deleteChecklistItem = (id) => { if(confirm('åˆªé™¤æ­¤é …ç›®ï¼Ÿ')) { checklist.value = checklist.value.filter(i => i.id !== id); saveData(); }};
                
                // ğŸ”¥ ä¿®æ”¹ 2: å–®ä¸€åˆªé™¤ä¿®å¾© (å‚³å…¥ ID èˆ‡é¡å‹)
                const deleteItem = (id, type) => { 
                    if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { 
                        if (type === 'itinerary') itinerary.value = itinerary.value.filter(i => i.id !== id);
                        else if (type === 'expenses') expenses.value = expenses.value.filter(i => i.id !== id);
                        saveData(); 
                    }
                };

                const submitForm = () => {
                    if (currentTab.value === 'itinerary') {
                        if (!form.value.location) return;
                        if (isEditing.value) {
                            const index = itinerary.value.findIndex(i => i.id === form.value.id);
                            if (index !== -1) {
                                const dateChanged = itinerary.value[index].date !== form.value.date;
                                itinerary.value[index] = { ...itinerary.value[index], ...form.value };
                                if(dateChanged) itinerary.value[index].order = 999;
                            }
                        } else {
                            itinerary.value.push({ 
                                id: Date.now(), 
                                ...form.value,
                                weather: null, 
                                order: currentDayItinerary.value.length 
                            });
                        }
                        const target = itinerary.value.find(i => i.location === form.value.location);
                        if(target) fetchWeather(target);
                    } else { 
                        if (!form.value.amount) return;
                        if (isEditing.value) {
                            const index = expenses.value.findIndex(e => e.id === form.value.id);
                            if (index !== -1) expenses.value[index] = { ...expenses.value[index], ...form.value };
                        } else {
                            expenses.value.push({ id: Date.now(), ...form.value, order: currentDayExpenses.value.length });
                        }
                    }
                    saveData(); 
                    closeModal();
                };

                const getWeatherIcon = (code) => { if (code <= 1) return 'fa-solid fa-sun text-yellow-500'; if (code <= 3) return 'fa-solid fa-cloud-sun text-gray-400'; return 'fa-solid fa-cloud-rain text-blue-400'; };
                const getCategoryIcon = (cat) => { const map = { 'é£²é£Ÿ': 'fa-utensils', 'äº¤é€š': 'fa-train-subway', 'é–€ç¥¨': 'fa-ticket', 'ä½å®¿': 'fa-bed', 'å…¶ä»–': 'fa-star' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const fetchWeather = async (item) => { item.weather = { temp: Math.floor(Math.random() * 8) + 18, code: Math.floor(Math.random() * 5) }; };

                return {
                    currentTab, showModal, isEditing, isSearching, suggestions, form, dates, selectedDate, selectDate,
                    currentDayItinerary, currentDayExpenses, dayTotalEUR, dayTotalTWD, allTotalEUR, allTotalTWD,
                    itinerary, expenses, checklist, newCheckItem, hasEvent, itineraryListRef, expenseListRef,
                    openModal, editItem, editExpense, submitForm, closeModal, deleteItem, toggleCheck, addChecklistItem, deleteChecklistItem,
                    getWeatherIcon, getCategoryIcon, locateMe, currentFullDateDisplay, onLocationInput, selectSuggestion
                };
            }
        }).mount('#app');
    </script>
</body>
</html>