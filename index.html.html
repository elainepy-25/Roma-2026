<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 南義之旅</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0e6d2;
            user-select: none;
        }
        [v-cloak] { display: none; }
    </style>
</head>

<body class="h-screen overflow-hidden">

<div id="app" v-cloak class="h-full">

<!-- ================== 主程式 ================== -->
<script>
const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

firebase.initializeApp({
    apiKey: "AIzaSyDotF5SMPWJ_gNKCFzH_ACIc8qi1xczd-k",
    authDomain: "roma-2026.firebaseapp.com",
    databaseURL: "https://roma-2026-default-rtdb.firebaseio.com",
    projectId: "roma-2026"
});
const db = firebase.database();

createApp({
setup() {

    /* ---------- 狀態 ---------- */
    const currentTab = ref('itinerary');
    const showModal = ref(false);
    const isEditing = ref(false);
    const isSaving = ref(false);
    const isDataLoaded = ref(false);

    const itinerary = ref([]);
    const expenses = ref([]);

    const selectedDate = ref('2026-05-19');

    const form = ref({
        id: null,
        date: '',
        time: '',
        location: '',
        note: '',
        item: '',
        amount: '',
        category: '飲食',
        currency: 'EUR',
        lat: '',
        lng: ''
    });

    /* ---------- 載入資料 ---------- */
    onMounted(() => {
        db.ref('trips/rome2026/itinerary').on('value', s => {
            itinerary.value = s.val() ? Object.values(s.val()) : [];
            isDataLoaded.value = true;
        });

        db.ref('trips/rome2026/expenses').on('value', s => {
            expenses.value = s.val() ? Object.values(s.val()) : [];
        });
    });

    /* ---------- 計算 ---------- */
    const currentDayItinerary = computed(() =>
        itinerary.value.filter(i => i.date === selectedDate.value)
    );

    /* ---------- 新增 / 編輯 ---------- */
    const openModal = () => {
        isEditing.value = false;
        form.value = {
            id: null,
            date: selectedDate.value,
            time: '09:00',
            location: '',
            note: '',
            lat: '',
            lng: ''
        };
        showModal.value = true;
    };

    const editItem = (item) => {
        isEditing.value = true;
        form.value = JSON.parse(JSON.stringify(item)); // ✅ 深拷貝
        showModal.value = true;
    };

    /* ---------- 儲存 ---------- */
    const submitForm = async () => {
        isSaving.value = true;
        const refPath = 'trips/rome2026/itinerary';

        let id = form.value.id;
        if (!isEditing.value) {
            id = db.ref(refPath).push().key;
        }

        await db.ref(`${refPath}/${id}`).update({
            ...form.value,
            id
        });

        showModal.value = false;
        isSaving.value = false;
    };

    /* ---------- 刪除（直接執行） ---------- */
    const deleteItem = (id) => {
        itinerary.value = itinerary.value.filter(i => i.id !== id);
        db.ref(`trips/rome2026/itinerary/${id}`).remove();
    };

    return {
        currentTab,
        showModal,
        isEditing,
        isSaving,
        itinerary,
        selectedDate,
        currentDayItinerary,
        openModal,
        editItem,
        deleteItem,
        submitForm,
        form
    };
}
}).mount('#app');
</script>

</div>
</body>
</html>
